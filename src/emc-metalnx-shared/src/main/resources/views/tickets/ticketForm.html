<!-- Create Ticket Form -->
<form role="form" class="container-fluid registerForm"
      method="POST" th:object="${ticket}"
      th:action="@{${requestMapping}}">
    <input type="hidden" class="form-control" id="inputPath" th:field="*{path}"/>
    <input type="hidden" class="form-control" id="usersList"/>
    <div class="form-group">
        <label class="control-label" th:text="#{ticket.form.path.label}"></label>
        <span id="selectedPath"></span>
    </div>
    <div class="form-group">
        <label for="input-permission" class="control-label" th:text="#{ticket.form.permission.label}"></label>
        <div class="">
            <select id="input-permission" class="form-control" th:field="*{type}">
                <option value="READ" th:text="#{ticket.form.permission.option.read.label}"></option>
                <option value="WRITE" th:text="#{ticket.form.permission.option.write.label}"></option>
            </select>
        </div>
    </div>
    <button id="btnShowAdvancedSettings" type="button" class="btn btn-link pull-right" th:text="#{ticket.form.show.advanced.settings.button}"></button>
    <button id="btnHideAdvancedSettings" type="button" class="btn btn-link pull-right hidden" th:text="#{ticket.form.hide.advanced.settings.button}"></button>
    <div class="advanced-settings hidden">
        <div class="form-group optional">
            <label for="inputTicketString" class="control-label" th:text="#{ticket.form.ticket.string.label}"></label>
            <input type="text" class="form-control" id="inputTicketString" maxlength="15" th:placeholder="#{ticket.form.ticket.string.placeholder}" th:field="*{ticketString}" value=""/>
            <i class="form-control-feedback glyphicon glyphicon-remove hideElement" id="invalidTicketStringIcon"></i>
            <small class="help-block hideElement" id="ticketStringInvalidMsg" th:text="#{ticket.form.validation.input.ticket.string.not.valid}"></small>
        </div>
        <div class="form-group optional">
            <label for="inputUsesLimit" class="control-label" th:text="#{ticket.form.uses.limit.label}"></label>
            <input type="text" class="form-control" id="inputUsesLimit" th:placeholder="#{ticket.form.uses.limit.placeholder}" th:field="*{usesLimit}" th:value="*{usesLimit}==0?'':*{usesLimit}"/>
            <i class="form-control-feedback glyphicon glyphicon-remove hideElement" id="invalidInputUsesLimitIcon"></i>
            <small class="help-block hideElement" id="usesLimitNotNumberMsg" th:text="#{ticket.form.validation.input.uses.limit.not.number}"></small>
        </div>
        <div class="form-group optional">
            <label for="inputWriteByteLimit" class="control-label" th:text="#{ticket.form.write.byte.limit.label}"></label>
            <input type="text" class="form-control" id="inputWriteByteLimit" th:placeholder="#{ticket.form.write.byte.limit.placeholder}" th:field="*{writeByteLimit}" value=""/>
            <i class="form-control-feedback glyphicon glyphicon-remove hideElement" id="invalidInputWriteByteLimitIcon"></i>
            <small class="help-block hideElement" id="writeByteNotNumberMsg" th:text="#{ticket.form.validation.input.write.byte.limit.not.number}"></small>
        </div>
        <div class="form-group optional">
            <label for="inputWriteFileLimit" class="control-label" th:text="#{ticket.form.write.file.limit.label}"></label>
            <input type="text" class="form-control" id="inputWriteFileLimit" th:placeholder="#{ticket.form.write.file.limit.placeholder}" th:field="*{writeFileLimit}" value=""/>
            <i class="form-control-feedback glyphicon glyphicon-remove hideElement" id="invalidInputWriteFiletIcon"></i>
            <small class="help-block hideElement" id="writeFileNotNumberMsg" th:text="#{ticket.form.validation.input.write.file.limit.not.number}"></small>
        </div>
        <div class="form-group optional">
            <label for="inputExpirationDate" class="control-label" th:text="#{ticket.form.expiration.date.label}"></label>
            <input type="text" class="form-control" id="inputExpirationDate" th:placeholder="#{ticket.form.expiration.date.placeholder}" th:field="*{expirationDate}" value=""/>
        </div>
        <div class="form-group optional">
            <label for="usersToBeAdded" th:text="#{ticket.form.users.label}"></label>
            <br />
            <input type="search" class="form-control col-md-12" id="usersToBeAdded" th:field="*{users}" autocomplete="off" data-provide="typeahead"/>
            <i class="form-control-feedback glyphicon glyphicon-remove hideElement nonexistentUsernameError" id="nonexistentUsernameIcon"></i>
            <small class="help-block hideElement nonexistentUsernameError" id="nonexistentUsernameMsg"
                   th:text="#{permission.validation.username.nonexistent}"></small>
        </div>
        <div class="form-group optional">
            <label for="groupsToBeAdded" th:text="#{ticket.form.groups.label}"></label>
            <br />
            <input type="search" class="form-control col-md-12" id="groupsToBeAdded" th:field="*{groups}" autocomplete="off" data-provide="typeahead"/>
            <i class="form-control-feedback glyphicon glyphicon-remove hideElement nonexistentGroupError" id="nonexistentGroupIcon"></i>
            <small class="help-block hideElement nonexistentGroupError" id="nonexistentGroupMsg"
                   th:text="#{permission.validation.group.nonexistent}"></small>
        </div>
        <div class="form-group optional">
            <label id="hostnamesLabel" for="inputHostnames" class="control-label" th:text="#{ticket.form.hostnames.label}"></label>
            <input type="text" class="form-control pull-left" id="inputNewHostname" th:placeholder="#{ticket.form.hostnames.placeholder}"/>
            <a id="addHostname" class="btn btn-default pull-right disabled"><i class="fa fa-plus-circle" aria-hidden="true"></i><span th:text="#{ticket.form.hostnames.add.btn}"></span></a>
            <div id="panelHostnames">
                <ul id="listHostnames">
                </ul>
                <input type="hidden" id="hostnames"/>
            </div>
        </div>
    </div>
</form>

<script type="text/javascript" th:src="@{/js/formValidator.js}"></script>
<script th:inline="javascript">
/*<![CDATA[*/
    // Check if all fiels are valid
    function allFieldsValidated(){
        var validated = !$('.form-group').hasClass("has-feedback has-error");
        return validated;
    }
    $(document).ready(function(e){

        $("#addHostname").prop("disabled", true);

        // Users restriction settings
        // Creates bloodhound instance for querying requests
        function createBloodhoundInstance(url, filterFunction) {
            return new Bloodhound({

                datumTokenizer : function(datum) {
                    return Bloodhound.tokenizers.whitespace(datum.value);
                },

                queryTokenizer : Bloodhound.tokenizers.whitespace,
                remote : {
                    url : url,
                    wildcard : '%QUERY',
                    filter : filterFunction
                }
            });
        }

        // Configures the data source for the tag input on the users modal
        function filterUsers(users) {
            return $.map(users.results, function(user) {
                return {
                    name: user.first_name + " " + user.last_name,
                    username: user.username
                };
            });
        }

        var usersSource = createBloodhoundInstance('/emc-metalnx-web/users/query/%QUERY/', filterUsers);

        if(!$("#usersToBeAdded").val()){
            $("#usersToBeAdded").attr("placeholder", [[#{ticket.form.users.placeholder}]]);
        }

        // Sets the text input on the group modal to be a tag input
        $('#usersToBeAdded').tagsinput({
            tagClass : 'label label-primary',
            freeInput: false,
            typeaheadjs : {
                displayKey: 'username',
                valueKey: 'username',
                source : usersSource,
                options: {
                    hint: true,
                    highlight: true,
                    minLength: 1
                },
                templates: {
                    empty: [
                      '<div class="empty-message">',
                        'Unable to find any user that match the current query',
                      '</div>'
                    ].join('\n')
                }
            }
        });

        $("#usersToBeAdded").on('itemAdded', function(event) {
            $('.tt-input').attr('placeholder','');
        });


        // Configures the data source for the tag input on the group modal
        function filterGroups(groups) {
            return $.map(groups, function(group) {
                return {
                    value: group
                };
            });
        }

        var groupsSource = createBloodhoundInstance('/emc-metalnx-web/groups/query/%QUERY/', filterGroups);
        if(!$("#groupsToBeAdded").val()){
            $("#groupsToBeAdded").attr("placeholder", [[#{ticket.form.groups.placeholder}]]);
        }

        // Sets the text input on the group modal to be a tag input
        $('#groupsToBeAdded').tagsinput({
            tagClass : 'label label-primary',
            freeInput: false,
            typeaheadjs : {
                displayKey: 'value',
                valueKey: 'value',
                source : groupsSource,
                options: {
                    hint: true,
                    highlight: true,
                    minLength: 1
                },
                templates: {
                    empty: [
                      '<div class="empty-message">',
                        'Unable to find any group that match the current query',
                      '</div>'
                    ].join('\n')
                }
            }
        });

        $("#groupsToBeAdded").on('itemAdded', function(event) {
            $('.tt-input').attr('placeholder','');
        });


        // Replace value '0' for a placeholder on fields: Uses Limit, Write Byte and Write File Limit
        if ($("#inputUsesLimit").val()==0){
            $("#inputUsesLimit").val('');
        }
        if ($("#inputWriteByteLimit").val()==0){
            $("#inputWriteByteLimit").val('');
        }
        if ($("#inputWriteFileLimit").val()==0){
            $("#inputWriteFileLimit").val('');
        }

        // Toggle advanced settings buttons visibility
        $("#btnShowAdvancedSettings").click(function(){
            $(".advanced-settings").removeClass("hidden");
            $(this).addClass("hidden");
            $("#btnHideAdvancedSettings").removeClass("hidden");
        });
        $("#btnHideAdvancedSettings").click(function(){
            $(".advanced-settings").addClass("hidden");
            $(this).addClass("hidden");
            $("#btnShowAdvancedSettings").removeClass("hidden");
        });

        // Set date format for Expiration Date field
        $("#inputExpirationDate").datepicker({
            dateFormat: "yy-mm-dd",
            minDate: 1
        });

        //Checks if input is a valid Ticket String
        function isValidTicketString(ticketString) {
            var isValidTicketString;
            var ticketRE = /^[0-9a-zA-Z]+$/;
            isValidTicketString = (isNaN(ticketString)) &&(ticketString.match(ticketRE));
            return isValidTicketString;
        }

        //Check if input is an Integer
        function isInteger(limit){
            var isInt = !isNaN(limit) && (parseInt(Number(limit)))==limit && !isNaN(parseInt(limit,10));
            return isInt;
        }

        // Ticket String field validation
        $("#inputTicketString").on('input propertychange',function(){
            if(!isValidTicketString($(this).val()) && !($(this).val()=='')){
                $("#inputTicketString").parent().addClass("has-feedback has-error");
                $("#invalidTicketStringIcon").show();
                $("#ticketStringInvalidMsg").show();
                $("#createTicketFormBtn").addClass("disabled");
                $("#createTicketFormBtn").prop("disabled", true);
            }
            else {
                $("#inputTicketString").parent().removeClass("has-feedback has-error");
                $("#invalidTicketStringIcon").hide();
                $("#ticketStringInvalidMsg").hide();
                $("#createTicketFormBtn").prop("disabled", false);
                $("#createTicketFormBtn").removeClass("disabled");
            }
        });

        // Uses Limit field validation
        $("#inputUsesLimit").on('input propertychange',function(){
            if(!isInteger($(this).val()) && !($(this).val()=='')){
                $("#inputUsesLimit").parent().addClass("has-feedback has-error");
                $("#invalidInputUsesLimitIcon").show();
                $("#usesLimitNotNumberMsg").show();
                $("#createTicketFormBtn").addClass("disabled");
                $("#createTicketFormBtn").prop("disabled", true);
            }
            else {
                $("#inputUsesLimit").parent().removeClass("has-feedback has-error");
                $("#invalidInputUsesLimitIcon").hide();
                $("#usesLimitNotNumberMsg").hide();
                $("#createTicketFormBtn").prop("disabled", false);
                $("#createTicketFormBtn").removeClass("disabled");
            }
        });

        // Write Byte field validation
        $("#inputWriteByteLimit").on('input propertychange',function(){
            if(!isInteger($(this).val()) && !($(this).val()=='')){
                $("#inputWriteByteLimit").parent().addClass("has-feedback has-error");
                $("#invalidInputWriteByteLimitIcon").show();
                $("#writeByteNotNumberMsg").show();
                $("#createTicketFormBtn").addClass("disabled");
                $("#createTicketFormBtn").prop("disabled", true);
            }
            else {
                $("#inputWriteByteLimit").parent().removeClass("has-feedback has-error");
                $("#invalidInputWriteByteLimitIcon").hide();
                $("#writeByteNotNumberMsg").hide();
                $("#createTicketFormBtn").prop("disabled", false);
                $("#createTicketFormBtn").removeClass("disabled");
            }
        });

        // Write File field validation
        $("#inputWriteFileLimit").on('input propertychange',function(){
            if(!isInteger($(this).val()) && !($(this).val()=='')){
                $("#inputWriteFileLimit").parent().addClass("has-feedback has-error");
                $("#invalidInputWriteFiletIcon").show();
                $("#writeFileNotNumberMsg").show();
                $("#createTicketFormBtn").addClass("disabled");
                $("#createTicketFormBtn").prop("disabled", true);
            }
            else {
                $("#inputWriteFileLimit").parent().removeClass("has-feedback has-error");
                $("#invalidInputWriteFiletIcon").hide();
                $("#writeFileNotNumberMsg").hide();
                $("#createTicketFormBtn").prop("disabled", false);
                $("#createTicketFormBtn").removeClass("disabled");
            }
        });

        $("#inputNewHostname").on('input propertychange', function(){
            if ($("#inputNewHostname").val() != '') {
                $("#addHostname").prop("disabled", false);
                $("#addHostname").removeClass("disabled");
            }
            else {
                $("#addHostname").prop("disabled", true);
                $("#addHostname").addClass("disabled");
            }
        });

        $("#addHostname").on('click', function () {
            var inputValue = $("#inputNewHostname").val();
            var removeBtn = "<a class='btn btn-link pull-right btn-remove' onclick='removeHost(\"" + inputValue + "\")'><i class='fa fa-minus-circle text-danger' aria-hidden='true'></i></a>";
            var newElement = "<li id='"+$("#inputNewHostname").val()+"'><span>" + $("#inputNewHostname").val() + "</span>"+ removeBtn+ "</li>";
            $("ul#listHostnames").append(newElement);
            $("#hostnames").append($("#inputNewHostname").val()+",");
            $("#hostnames").val($("#hostnames").text());
            $("#inputNewHostname").val('');
            $("#addHostname").prop("disabled", true);
            $("#addHostname").addClass("disabled");
        });
    });
    function removeHost(hostname){
        var listItem = document.getElementById(hostname);
        var list = listItem.parentElement;
        list.removeChild(listItem);
    }
/*]]>*/
</script>