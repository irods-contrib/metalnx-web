<!DOCTYPE html>
<!--
  ~    Copyright (c) 2015-2016, EMC Corporation
  ~
  ~ 	Licensed under the Apache License, Version 2.0 (the "License");
  ~    you may not use this file except in compliance with the License.
  ~    You may obtain a copy of the License at
  ~
  ~        http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~    Unless required by applicable law or agreed to in writing, software
  ~    distributed under the License is distributed on an "AS IS" BASIS,
  ~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~    See the License for the specific language governing permissions and
  ~    limitations under the License.
  ~
  -->

<html lang="en"
	layout:decorator="template">

<head>
	<title th:text="#{tab.title.collections}">EMC Metalnx - Collections</title>
</head>

<body>
	<div layout:fragment="content">
		<h1 class="page-header pull-left" th:text="#{collections.management.page.title}" th:data-content="#{collection.title.popover}"></h1>
		<a id="collections-page-title" href="#" class="page-hint pull-right"><i class="fa fa-question-circle"></i></a>
		<ol class="breadcrumb mlx"  th:if="${cameFromMetadataSearch} == true"
					id="backToMetadataSearch">
		  <li><a href="/emc-metalnx-web/metadata/?backFromCollections=true">Search Results</a></li>
		  <li class="active">Collections</li>
		</ol> 
		<ol class="breadcrumb mlx"  th:if="${cameFromFilePropertiesSearch} == true"
					id="backToFilePropertiesSearch">
		  <li><a href="/emc-metalnx-web/fileproperty/?backFromCollections=true">Search Results</a></li>
		  <li class="active">Collections</li>
		</ol> 
        <div class="header-line"></div>
        <div th:if="${unexpectedError}">
            <div class="alert alert-danger alert-dismissible text-center" role="alert">
                <button type="button" class="close" data-dismiss="alert">
                    <span aria-hidden="true">&times;</span> <span class="sr-only">Close</span>
                </button>
                <span th:text="${'An unexpected error has happened. Please, contact your system administrator.'}"></span>
            </div>
        </div>
        
		<div class="row" th:unless="${unexpectedError}">
        
            <!-- Empty trash succeed -->
            <div th:if="${uploadNewTab}" class="col-sm-12" id="">
                <div class="alert alert-info alert-dismissible text-center" role="alert">
                    <button type="button" class="close" data-dismiss="alert">
                        <span aria-hidden="true">&times;</span> <span class="sr-only">Close</span>
                    </button>
                    <span> Your upload may be still running in the previous tab and not all files will be available until the upload is complete. </span>
                </div>
            </div>
            
            <!-- Empty trash succeed -->
            <div class="col-sm-12 hideElement" id="trashEmptiedSuccessfully">
                <div class="alert alert-success alert-dismissible text-center" role="alert">
                    <button type="button" class="close" data-dismiss="alert">
                        <span aria-hidden="true">&times;</span> <span class="sr-only">Close</span>
                    </button>
                    <span> All trash items were removed successfully. </span>
                </div>
            </div>
            
            <!-- Empty trash fail -->
            <div class="col-sm-12 hideElement" id="trashNotEmptiedSuccessfully">
                <div class="alert alert-danger alert-dismissible text-center"
                    role="alert">
                    <button type="button" class="close" data-dismiss="alert">
                        <span aria-hidden="true">&times;</span> <span class="sr-only">Close</span>
                    </button>
                    <span> Trash items could not be deleted. </span>
                </div>
            </div>

			<!-- Apply templates succeed -->
			<div th:if="${templatesAppliedSuccessfully}" class="col-sm-12" id="applyTemplateSuccess">
				<div class="alert alert-success alert-dismissible text-center" role="alert">
					<button type="button" class="close" data-dismiss="alert">
						<span aria-hidden="true">&times;</span> <span class="sr-only">Close</span>
					</button>
					<span> Templates were successfully applied. </span>
				</div>
			</div>

			<!-- Apply templates fail -->
			<div th:if="${templatesAppliedSuccessfully == false}" class="col-sm-12" id="applyTemplateFailure">
				<div class="alert alert-danger alert-dismissible text-center" role="alert">
					<button type="button" class="close" data-dismiss="alert">
						<span aria-hidden="true">&times;</span> <span class="sr-only">Close</span>
					</button>
					<span> Templates could not be applied. Please, check if
						there is any duplicated metadata. </span>
				</div>
			</div>

			<!-- Collection creation fail message -->
			<div th:if="${missingPermissionError}" class="col-sm-12" id="creationErrorMessages">
				<div class="alert alert-danger alert-dismissible text-center" role="alert">
					<button type="button" class="close" data-dismiss="alert">
						<span aria-hidden="true">&times;</span> <span class="sr-only">Close</span>
					</button>
					<span> Add collection failed. Please, check if you have
						permissions to perform such operation. </span>
				</div>
			</div>

			<div class="col-sm-12">
				<div th:if="${ collectionAddedSuccessfully != null or collectionModifiedSuccessfully != null }"
					class="alert alert-success alert-dismissible text-center" role="alert">
					<button type="button" class="close" data-dismiss="alert">
						<span aria-hidden="true">&times;</span> <span class="sr-only">Close</span>
					</button>
					<b>	<span th:if="${ collectionAddedSuccessfully }" th:text="${ collectionAddedSuccessfully }"></span></b> 
					<b>	<span th:if="${ collectionModifiedSuccessfully }" th:text="${ collectionModifiedSuccessfully }"></span></b> 
						<span th:if="${ collectionAddedSuccessfully }" th:text="#{ confirmation.add.successfully }"></span>
						<span th:if="${ collectionModifiedSuccessfully }" th:text="#{ confirmation.modify.successfully }"></span>
				</div>
			</div>

			<!-- All items replicated successfully -->
			<div class="col-sm-12">
				<div th:if="${failedReplicas != null and #lists.isEmpty(failedReplicas)}" class="alert alert-success alert-dismissible text-center" role="alert">
					<button type="button" class="close" data-dismiss="alert">
						<span aria-hidden="true">&times;</span> <span class="sr-only">Close</span>
					</button>
					<span>All items replicated successfully.</span>
				</div>
			</div>

			<!-- Some items didn't get replicated -->
			<div class="col-sm-12">
				<div th:if="${not #lists.isEmpty(failedReplicas)}" class="alert alert-danger alert-dismissible text-center" role="alert">
					<button type="button" class="close" data-dismiss="alert">
						<span aria-hidden="true">&times;</span> <span class="sr-only">Close</span>
					</button>
					<span>The following items failed to be replicated: </span> <span
						th:text="${#strings.toString(failedReplicas)}"></span>
					<span>. Please, check if you have permissions to perform such operation.</span>
				</div>
			</div>

			<div class="col-sm-12 tree-view-panel">
				<div id="tree-view-panel-body" class="row"></div>
			</div>

			<div class="col-sm-12 hideElement" id="templatesListPanel">
				<div id="templatesListPanelBody" class="row"></div>
			</div>
		</div>
		
		<!-- template modal -->
		<div class="modal fade" id="applyTemplateModal" tabindex="-1"
			role="dialog" aria-labelledby="applyTemplateModalLabel"
			aria-hidden="true"></div>

		<!-- Add Modal -->
		<div class="modal fade" id="addAndModifyModal" tabindex="-1"
			role="dialog" aria-labelledby="myAddAndModifyModalLabel"
			aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-form-content"></div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default cancelBtn" data-dismiss="modal" th:text="#{forms.cancel.action.button}"></button>
						<button type="button" class="btn btn-primary" id="submitCollectionFormBtn" th:text="#{forms.save.action.button}"></button>
					</div>
				</div>
			</div>
		</div>
		<!-- /Add Modal -->

		<!-- Copy Modal -->
		<div class="modal fade" id="copyModal" tabindex="-1" role="dialog"
			aria-labelledby="myCopyModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">
							<span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
						</button>
						<h4 class="modal-title" id="myCopyModalLabel">Copy item to</h4>
					</div>
					<div class="modal-body">
						<ul class="nav nav-tabs" role="tablist">
							<li role="presentation" class="active">
								<a href="#copyCollections" aria-controls="copyCollections" role="tab" data-toggle="tab"><i class="fa fa-folder"></i> Collections</a>
							</li>
							<li role="presentation" class="">
								<a href="#copyShared" aria-controls="copyShared" role="tab" data-toggle="tab"><i class="fa fa-share-alt"></i> Shared</a>
							</li>
							<li role="presentation" class="">
								<a href="#copyGroups" aria-controls="copyGroups" role="tab" data-toggle="tab"><i class="fa fa-users"></i> Groups</a>
							</li>
							<li role="presentation" class="">
								<a href="#copyFavorites" aria-controls="copyFavorites" role="tab" data-toggle="tab"><i class="fa fa-star"></i> Favorites</a>
							</li>
						</ul>
						<div class="tab-content col-md-12 col-sm-12">
							<div role="tabpanel" class="tab-pane active" id="copyCollections">
								<th:block th:if="${userDetails.isAdmin()}">
									<p>
										<a href="#" name="/" title="/"
											onclick="getSubDirectoriesOldTree('iRods', '/');"> <img
											alt="" class="folder-icon" th:src="@{ /images/folder-16.png }"
											name="/" /> <span>iRods</span>
										</a>
									</p>
								</th:block>
								<th:block th:unless="${userDetails.isAdmin()}">
									<p>
										<a href="#" th:name="${homePath}"
											th:title="${userDetails.getUsername()}"
											th:onclick="'javascript:getSubDirectoriesOldTree(\'' + ${userDetails.getUsername()} + '\', \'' + ${homePath} + '\');'">
			
											<img alt="" class="folder-icon"
											th:src="@{ /images/folder-16.png }" name="/" /> <span
											th:text="${userDetails.getUsername()}"></span>
										</a>
									</p>
									<p>
										<a href="#" th:name="Public" th:title="Public"
											th:onclick="'javascript:getSubDirectoriesOldTree(\'Public\', \'' + ${publicPath} + '\');'">
											<i class="glyphicon glyphicon-globe"></i> <span>Public</span>
										</a>
									</p>
								</th:block>
							</div>
							<div role="tabpanel" class="tab-pane" id="copyShared">
			                	<table class="table table-hover" id="copyUserBookmarksTable">
			                        <thead>
			                            <tr>
			                                <th th:text="#{bookmarks.table.file.name.label}"></th>
			                                <th th:text="#{bookmarks.table.file.path.label}"></th>
			                            </tr>
			                        </thead>
			                    </table>
							</div>
						    <div role="tabpanel" class="tab-pane" id="copyGroups">
						    	<table class="table table-hover" id="copyGroupBookmarksTable">
			                        <thead>
			                            <tr>
			                                <th th:text="#{bookmarks.table.file.name.label}"></th>
			                                <th th:text="#{bookmarks.table.file.path.label}"></th>
			                                <th th:text="#{bookmarks.table.group.label}"></th>
			                            </tr>
			                        </thead>
			                    </table>
						    </div>
						    <div role="tabpanel" class="tab-pane" id="copyFavorites">
						    	<table class="table table-hover" id="copyFavoritesTable">
			                        <thead>
			                            <tr>
			                                <th th:text="#{favorites.table.name.label}"></th>
			                                <th th:text="#{favorites.table.path.label}"></th>
			                            </tr>
			                        </thead>
			                    </table>
						    </div>
						</div>
					</div>
					<div class="modal-footer">
						<div class="row">
							<div class="col-md-12 pull-right targetPathInfoDiv">Copy to: <i class="fa fa-folder-o"></i> <span class="targetPathInfoSpan">/</span></div>
							<div class="col-md-12">
								<button type="button" class="btn btn-default cancelBtn"
									id="cancelCopyBtn" th:text="#{forms.cancel.action.button}">
								</button>
								<button type="button" class="btn btn-primary" id="copyBtn"
									th:text="#{copy.label}"></button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- /.Copy Modal -->

		<!-- Move Modal -->
		<div class="modal fade" id="moveModal" tabindex="-1" role="dialog"
			aria-labelledby="myMoveModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">
							<span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
						</button>
						<h4 class="modal-title" id="myMoveModalLabel">Move item to</h4>
					</div>
					<div class="modal-body">
						<ul class="nav nav-tabs" role="tablist">
							<li role="presentation" class="active">
								<a href="#moveCollections" aria-controls="moveCollections" role="tab" data-toggle="tab"><i class="fa fa-folder"></i> Collections</a>
							</li>
							<li role="presentation" class="">
								<a href="#moveShared" aria-controls="moveShared" role="tab" data-toggle="tab"><i class="fa fa-share-alt"></i> Shared</a>
							</li>
							<li role="presentation" class="">
								<a href="#moveGroups" aria-controls="moveGroups" role="tab" data-toggle="tab"><i class="fa fa-users"></i> Groups</a>
							</li>
							<li role="presentation" class="">
								<a href="#moveFavorites" aria-controls="moveFavorites" role="tab" data-toggle="tab"><i class="fa fa-star"></i> Favorites</a>
							</li>
						</ul>
						<div class="tab-content col-md-12 col-sm-12">
							<div role="tabpanel" class="tab-pane active" id="moveCollections">
								<th:block th:if="${userDetails.isAdmin()}">
									<p>
										<a href="#" name="/" title="/"
											onclick="getSubDirectoriesOldTree('iRods', '/');"> <img
											alt="" class="folder-icon" th:src="@{ /images/folder-16.png }"
											name="/" /> <span>iRods</span>
										</a>
									</p>
								</th:block>
								<th:block th:unless="${userDetails.isAdmin()}">
									<p>
										<a href="#" th:name="${homePath}"
											th:title="${userDetails.getUsername()}"
											th:onclick="'javascript:getSubDirectoriesOldTree(\'' + ${userDetails.getUsername()} + '\', \'' + ${homePath} + '\');'">
			
											<img alt="" class="folder-icon"
											th:src="@{ /images/folder-16.png }" name="/" /> <span
											th:text="${userDetails.getUsername()}"></span>
										</a>
									</p>
									<p>
										<a href="#" th:name="Public" th:title="Public"
											th:onclick="'javascript:getSubDirectoriesOldTree(\'Public\', \'' + ${publicPath} + '\');'">
											<i class="glyphicon glyphicon-globe"></i> <span>Public</span>
										</a>
									</p>
								</th:block>
							</div>
							<div role="tabpanel" class="tab-pane" id="moveShared">
			                	<table class="table table-hover" id="moveUserBookmarksTable">
			                        <thead>
			                            <tr>
			                                <th th:text="#{bookmarks.table.file.name.label}"></th>
			                                <th th:text="#{bookmarks.table.file.path.label}"></th>
			                            </tr>
			                        </thead>
			                    </table>
							</div>
						    <div role="tabpanel" class="tab-pane" id="moveGroups">
						    	<table class="table table-hover" id="moveGroupBookmarksTable">
			                        <thead>
			                            <tr>
			                                <th th:text="#{bookmarks.table.file.name.label}"></th>
			                                <th th:text="#{bookmarks.table.file.path.label}"></th>
			                                <th th:text="#{bookmarks.table.group.label}"></th>
			                            </tr>
			                        </thead>
			                    </table>
						    </div>
						    <div role="tabpanel" class="tab-pane" id="moveFavorites">
						    	<table class="table table-hover" id="moveFavoritesTable">
			                        <thead>
			                            <tr>
			                                <th th:text="#{favorites.table.name.label}"></th>
			                                <th th:text="#{favorites.table.path.label}"></th>
			                            </tr>
			                        </thead>
			                    </table>
						    </div>
						</div>
					</div>
					<div class="modal-footer">
						<div class="row">
							<div class="col-md-12 pull-right targetPathInfoDiv">Move to: <i class="fa fa-folder-o"></i> <span class="targetPathInfoSpan">/</span></div>
							<div class="col-md-12">
								<button type="button" class="btn btn-default" id="cancelMoveBtn"
									th:text="#{forms.cancel.action.button}"></button>
								<button type="button" class="btn btn-primary" id="moveBtn"
									th:text="#{move.label}"></button>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<!-- /.Move Modal -->

		<!-- Replicate Modal -->
		<div class="modal fade" id="replicateModal" tabindex="-1"
			role="dialog" aria-labelledby="myReplicateModalLabel"
			aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">
							<span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
						</button>
						<h4 class="modal-title" th:text="#{replicate.modal.title}"></h4>
					</div>
					<div class="modal-body">
						<form action="/emc-metalnx-web/fileOperation/replicate/"
							method="POST" role="form" enctype="multipart/form-data"
							id="replicateForm">
							<div class="form-group">
								<label for="selectResourceForReplication"
									th:text="#{resource.label}"> </label>
								<div id="selectResourceForReplication"></div>
							</div>
						</form>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal"
							th:text="#{forms.cancel.action.button}"></button>
						<button type="button" class="btn btn-primary" id="replicateButton">
							<span th:text="#{replicate.label}"></span>
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Delete Modal -->
		<div class="modal fade" id="deleteModal" tabindex="-1" role="dialog"
			aria-labelledby="myModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">
							<span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
						</button>
						<h4 class="modal-title" th:text="#{confirmation.deletion.title}"></h4>
					</div>
					<div class="modal-body">
						<span th:text="#{confirmation.deletion.label}"></span> <span
							id="itemsToBeRemoved" style="font-weight: bold;"></span>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal"
							th:text="#{confirmation.message.no}"></button>
						<button type="button" class="btn btn-primary"
							onclick="deleteAction();" th:text="#{confirmation.message.yes}">
						</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Upload Modal -->
		<div class="modal fade" id="uploadModal" tabindex="-1" role="dialog"
			aria-labelledby="myModalLabel" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<button type="button" class="close" data-dismiss="modal">
							<span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
						</button>
						<h4 class="modal-title" th:text="#{upload.label}"></h4>
					</div>
					<div class="modal-body">
						<div class="hideElement" id="uploadMinMessage">
							<div class="alert alert-warning alert-dismissible text-center"
								role="alert">
								<button type="button" class="close" data-dismiss="alert">
									<span aria-hidden="true">&times;</span> <span class="sr-only">Close</span>
								</button>
								<span>Select at least one file</span>
							</div>
						</div>
						<!-- Form submitted as soon as the user selects all files to be uploaded -->
                        <form action="/emc-metalnx-web/upload/" method="POST"
                              role="form" enctype="multipart/form-data" id="uploadForm">

							
							<p class="text-right">
								<span id="numberFilesUpload">No</span><span>&nbsp;file(s)
									selected</span>
							</p>
							<div class="well">
								<!-- <div class="col-sm-4 col-sm-offset-4" style="align-items: center; display: flex; min-height: 100%;"> -->
									<button type="button" class="btn btn-primary btn-sm" id="browseButton" style="margin: 10% auto;">
										<span th:text="#{select.files.upload}"></span>
									</button>
								<!-- </div> -->
								<input type="file" multiple="multiple" name="files"
									id="inputFiles" class="form-control" />
								<div id="filesList">
								</div>
							</div>

							<div id="uploadControlOptions">
								<div class="row form-group">
									<div class="col-md-6">Resource</div>
									<div class="col-md-6">
											<input type="checkbox" id="inputReplica" name="replica"
												value="1" /> &nbsp;&nbsp;<span>Replica</span>
									</div>
									<div class="col-md-6">
										<select class="form-control" name="resourceToUpload"
											id="selectResourceToUpload">
										</select>
									</div>
									<div class="col-md-6">
										<select class="form-control" name="resources" disabled="disabled"
											id="selectResource">
										</select>
									</div>
								</div>

 								<div class="row form-group">
									<div class="col-md-6">
										<input type="checkbox" id="inputOverwriteDuplicateFiles"
											name="inputOverwriteDuplicateFiles"
											th:checked="${overwriteFileOption}" /> &nbsp;&nbsp;<span>Overwrite
											duplicate files</span>
									</div>
									<div class="col-md-6">
										<input type="checkbox" id="inputChecksum" name="checksum"
										value="1" /> &nbsp;&nbsp;<span>Checksum</span>
									</div>
 								</div>

							</div>
						</form>

					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal"
							th:text="#{forms.cancel.action.button}"></button>
						<a type="button" class="btn btn-primary" id="uploadButton" target="_blank" href="?uploadNewTab=true">
							<i class="fa fa-upload"></i> <span th:text="#{upload.label}"></span>
						</a>
					</div>
				</div>
			</div>
		</div>
        
		<script type="text/javascript" th:src="@{/js/formValidator.js}"></script>
		<script type="text/javascript" th:src="@{/js/filterTable.js}"></script>
		<script type="text/javascript" th:inline="javascript">
		/*<![CDATA[*/
			var targetPath = "/";
			var currentPath = [[${ currentPath }]];
			var totalCheckboxesChecked;
			var operationInProgress = false;
			var oldBreadCrumbContent;
			var unexpectedError = [[${unexpectedError}]] != null;
		
			$(document).ready(function(){	
				
				// Add popover on page title
		        $('#collections-page-title').popover({
		    		title:[[#{collections.management.page.title}]],
		    		content:[[#{collection.title.popover}]],
		   			trigger: 'hover click',
		       		placement: 'left',
		   		});
				
				$('#uploadControlOptions').hide();
				
				$('#uploadModal').on('show.bs.modal', function(){
					$('#uploadForm').each(function(){
						this.reset();
					});
					$('#filesList').html('');
					$('#numberFilesUpload').html('No');
					$('#uploadControlOptions').hide();
					$('#browseButton').show();
					
					// Hiding the resource selection box on the upload modal
					$("#selectResource").prop("disabled", true);
				});
				
				window.addEventListener("beforeunload", function (e) {
					if (operationInProgress) {
						var confirmationMessage = "An operation is in progress. If you leave this window now the consequences are unpredictable.";
						(e || window.event).returnValue = confirmationMessage;
						return confirmationMessage;
					}
				});
				
				if (!unexpectedError) {
				    getSubDirectories([[${ currentPath }]]);
				}
				
				if (![[${templatesAppliedSuccessfully}]]) {
					$("#applyTemplateSuccess").show();
					totalCheckboxesChecked = 0;$("#selectResource option").first().addClass("hideElement");
				}	
				else {
					$("#applyTemplateFailure").show();					
				}
			});

			function getSubDirectories(path) {	
				$("#table-loader").show();
				$("#tree-view-panel-body").hide();
				
				setTimeout(function () {
					ajaxEncapsulation("/emc-metalnx-web/collections/getSubDirectories/", "POST", {path: path}, displaySubDirectories, null, null, null);
					currentPath = path;
				}, 400);
			}

			function displaySubDirectories(data) {
			    resetDataTablesStart();
				$("#table-loader").hide();
				$("#tree-view-panel-body").show();
				$("#tree-view-panel-body").html(data);	
			}
			
	        function getSubDirectoriesOldTree(directoryName, directoryPath){
	        	$("#moveModal img[name='" + directoryPath + "']").attr("src", "../images/spinner-16.gif");	
				var groupName = $("#collectionInfoGroupName").text();
				
				ajaxEncapsulation(
					"/emc-metalnx-web/collections/getSubDirectoriesOldTree/", 
					"POST", 
					{path : directoryPath, groupName : groupName}, 
					function (data){
						$(".modal a[name='" + directoryPath + "']").attr("onclick", "retractElement('" + directoryName + "', '" + directoryPath + "');");
						$(".modal a[name='" + directoryPath + "']").parent().after(data);
						$(".modal img[name='" + directoryPath + "']").attr("src", "../images/folder-open-16.png");
						
						targetPath = directoryPath;	
						$('.targetPathInfoSpan').html(targetPath);
					}, null, null, null
				);
	        }
	        
	        function retractElement(directoryName, directoryPath) {
	        	$(".modal a[name='" + directoryPath + "']").attr("onclick", "getSubDirectoriesOldTree('" + directoryName + "', '" + directoryPath + "');");
				$(".modal a[name='" + directoryPath + "']").parent().next().toggle();
				$(".modal img[name='" + directoryPath + "']").attr("src", "../images/folder-16.png");
				
				targetPath = directoryPath;	
				$('.targetPathInfoSpan').html(targetPath);
	        }

	        $("#addAndModifyModal").keypress(function (e) {
	        	if (e.which == '13') {
	        		e.preventDefault();
	        	}
	        });
	        
	        function displayModifyForm(data){
	        	$("#addAndModifyModal .modal-form-content").html(data);
				$("#addAndModifyModal").modal("show");
	        }
	        
	        function showModifyForm() {	        	        	
	        	var url = [[ ${ urlMap.URL_MODIFY_COLLECTION_USER } ]];
		        ajaxEncapsulation(url, "GET", "", displayModifyForm, null, null, null);	 
			} 
	        
	        function submitForm() {
        		if(!$("#invalidCollectionNameIcon").is(":visible")){
					$(".registerForm").submit();								
				}	       	        	
	        }
	        
	        $("#submitCollectionFormBtn").click(function(){
	        	var newCollOrDataObjectName = $('#inputCollectionName').val();
	        	var parentPath = $('#inputCollectionParentPath').val();
	        	var collPath = $('#inputCollectionPath').val();
	        	
	        	if (collPath != "") {
	        		var oldCollName = path.substring(parentPath.length + 1, collPath.length);
	        	}
	        	
	        	if(collPath == "" || oldCollName != newCollOrDataObjectName) {
		        	validateCollectionNameAjax([[${urlMap.URL_COLLECTION_VALIDATE_NAME}]] + newCollOrDataObjectName, submitForm);
	        	}
	        	else {
	        		submitForm();
	        	}
			});
	        
	        function callbackMoveAndCopy(data){
				$("#moveModal").modal("hide");
				
				//reset the modal
        		cleanModals();
				
				//updating the list of files and collections
				currentPath = targetPath;					
				totalCheckboxesChecked = 0;
				
	       		resetDataTablesStart();	
	       		
				$("#tree-view-panel-body").html(data);
	        }
	        
	        function updateResourceForReplicationOptions() {
	        	$("#selectResource > option").remove();
    			$("#selectResourceToUpload > option").each(function() {
    				if(!$(this).is(":selected")) {
    					$("#selectResource").append($(this).clone());
    				}	    				
    			});
	        }
	        
	        $("#moveBtn").click(function() {
		        ajaxEncapsulation("/emc-metalnx-web/fileOperation/move/", "POST", {targetPath : targetPath}, callbackMoveAndCopy, null, null, null);
	        });
	        
	        $("#copyBtn").click(function() {
	        	ajaxEncapsulation("/emc-metalnx-web/fileOperation/copy/", "POST", {targetPath : targetPath}, callbackMoveAndCopy, null, null, null);
	        });
	        
	        $("#cancelMoveBtn").click(function() {
	        	cleanModals();	        	
	        });
	        
	        $("#cancelCopyBtn").click(function() {
	        	cleanModals();
	        });
	        
	        $("#selectResourceToUpload").change(function() {
	        	updateResourceForReplicationOptions();
	        });
	        
	        $("#inputReplica").change(function () {
	        	if($(this).is(":checked")) {	   
	        		updateResourceForReplicationOptions();	    			
	                $("#selectResource").prop("disabled", false);
	            }
	        	else {
	                $("#selectResource").prop("disabled", true);        		
	        	}
			});
	        
	        $("#browseButton").click(function(){
				$("input[name='files']").click();
			});
	        
	        $("#replicateButton").click(function(){
	        	$("#replicateForm").submit();
			});
	        
	        function deleteAction(){
	        	setOperationInProgress();
	        	$("#actions a").hide();
	        	$('#actionRemoval').show();
	        	$('#actionUpload').hide();
	        	ajaxEncapsulation(
	        		"/emc-metalnx-web/fileOperation/delete/", 
	        		"POST", 
	        		"", 
	        		function (data) {
		        		$('#actionRemoval').hide();
		        		unsetOperationInProgress();
		        		
		        		resetDataTablesStart();	
		        		
	        			$("#tree-view-panel-body").html(data);
					}, null, null, null
				);
				
				$("#deleteModal").modal("hide");
				
				cleanModals();
	        }
	        
	        $('.modal').on('hidden.bs.modal', function(e){
	        	$(".modal a").each(function(){
					if($(this).attr('onclick') !== undefined){
						if($(this).attr('onclick').indexOf('retractElement') >= 0){
							eval($(this).attr('onclick'));
						}
					}
				});
	        });
	        
	        function cleanModals() {
				$(".modal").modal("hide");
				
				//reset the modal
				$(".modal a").each(function(){
					if($(this).attr('onclick') !== undefined){
						if($(this).attr('onclick').indexOf('retractElement') >= 0){
							eval($(this).attr('onclick'));
						}
					}
				});
	        }
	        
	        function setOperationInProgress() {
	        	oldBreadCrumbContent = $(".breadcrumb").html();
	        	$(".breadcrumb a").attr('onclick', '');
	        	$(".breadcrumb a").css('color', '#ccc');
	        	$(".breadcrumb span").css('color', '#ccc');
	        	$(".breadcrumb a").css('cursor', 'default');
	        	operationInProgress = true;
	        }
	        
	        function unsetOperationInProgress() {
	        	$(".breadcrumb").html(oldBreadCrumbContent);
	        	operationInProgress = false;
	        }
	        
	        function getTemplatesToBeApplied() {
	        	var templateIDsList = $("#templatesListTable input[type=checkbox]:checked").map(function() {
	        		return $(this).val();
	        	}).get().join(); 
	        	
	        	return templateIDsList;
	        }
	        function goBackToTemplatesList() {
	        	$(".template-fields-content").hide();	  
	        	$(".templates-content").show();
	        }
	        
	        function displayTemplates(response) {
	        	$(".templates-content").remove();
	        	$("#applyTemplateModal").html(response);
	        	$('#applyTemplateModal').modal('show');
			}
	        
	        function displayTemplateFields(response) {
	        	$(".template-fields-content").remove();
	        	$(".templates-content").hide();
	        	$(".templates-content").after(response);
	        	$(".template-fields-content input[name='applyToCurrentPath']").val(applyToCurrentPath);	     
	        	applyToCurrentPath = false;
			}
	        
	        function listAllTemplates() {	  
	        	var url = "/emc-metalnx-web/templates/listTemplatesForCollections/";
				ajaxEncapsulation(url, "POST", null, displayTemplates, null, null);	
	        }
	        
	        function listTemplateFields() {
	        	var templateIDsList = getTemplatesToBeApplied();
				var url = "/emc-metalnx-web/templates/listTemplateFieldsForCollections/";
				ajaxEncapsulation(url, "POST", {templateIDsList : templateIDsList}, displayTemplateFields, null, null);
	        }
	        
	        function goToDataObjDetails(path){
				$("#table-loader").show();
				$("#table-loader").nextAll().remove();
	        	
				url = "/emc-metalnx-web/collections/info/";
				ajaxEncapsulation(url, "POST", {path: path}, displayInfoDetails, null, null, null);
				ajaxEncapsulation(
					'/emc-metalnx-web/collections/getBreadCrumbForObject/', 
					"POST", 
					{path: path}, 
					function(data){
						$("#directoryPath").html(data);
					}, null, null, null);
	        } 
	        
			function displayInfoDetails(data){
				$("#table-loader").hide();
				$("#table-loader").after(data);
	        }    
			function goBackHistory(steps){
				ajaxEncapsulation(
					'/emc-metalnx-web/collections/goBackHistory/', 
					"POST", 
					{steps: steps}, 
					displaySubDirectories, 
					null, null, null
				);
			}
			function goForwardHistory(steps){
				ajaxEncapsulation(
					'/emc-metalnx-web/collections/goForwardHistory/', 
					"POST", 
					{steps: steps}, 
					displaySubDirectories, 
					null, null, null
				);
			}

			function moveTo(path){
			    targetPath = path;
			    $('.targetPathInfoSpan').html(targetPath);
			}
			
			//this function below only wqorks with favorites and user bookmarks table because they have the same number of columns
			function modalMoveCopyFavAndUserbookmarkDatatable(datatableId, datatableVar, urlService){
			    datatableVar = $('#'+datatableId).DataTable( {
				    "serverSide": true,
				    "dom": dtPatternMlxStandard,
				    "language": i18n,
				    "destroy": true,
				    "autoWidth": false,
				    "ajax": {
				        url: urlService,
				        "data": function ( d ) {
	    		        	//this code adds a new parameter in the request
	    		            return $.extend( {}, d, {
	    		              "onlyCollections" : true
	    		            });
	    		          }
				    },
				    "order": [[ 1, 'asc' ]],
				    "initComplete": function(settings){
			            $('#'+ datatableId +' tbody td').each(function () {
			            	$(this).attr('title', $(this).text().trim());
			            });
			        },
			        "drawCallback": function(){
	    	            $(".dataTables_paginate.paging_simple_numbers .pagination").addClass("pagination-sm");
	    	            $('.dataTables_paginate.paging_simple_numbers')
	    	            .css( 'display', this.api().data().length <= 0 ?
	    	                 'none' :
	    	                 'block'
	    	            )
	    	        },
				    "columnDefs": [
		                {
		                	"render": function ( data, type, full, meta ) {
								return '<a href="#" onclick="moveTo(\''+full.path+'\')"><i class="'+full.displayIcon+'"></i>'+full.name+'</a>';
							},
							"width": "50%",
							"targets": 0
		                },
		                {
		                	"data": "path", 
		                	"width": "50%", 
		                	"targets": 1
		               	}
		            ]
				});
				addGoToPage(datatableId, datatableVar);
			}
			
			//tables for the move modal
			var moveFavoritesTable;
			var moveUserBookmarksTable;
			modalMoveCopyFavAndUserbookmarkDatatable('moveFavoritesTable', moveFavoritesTable, '/emc-metalnx-web/favorites/favoritesPaginated/');
			modalMoveCopyFavAndUserbookmarkDatatable('moveUserBookmarksTable', moveUserBookmarksTable, '/emc-metalnx-web/userBookmarks/bookmarksPaginated/');
			
			//tables for the copy modal
			var copyFavoritesTable;
			var copyUserBookmarksTable;
			modalMoveCopyFavAndUserbookmarkDatatable('copyFavoritesTable', copyFavoritesTable, '/emc-metalnx-web/favorites/favoritesPaginated/');
			modalMoveCopyFavAndUserbookmarkDatatable('copyUserBookmarksTable', copyUserBookmarksTable, '/emc-metalnx-web/userBookmarks/bookmarksPaginated/');
			
			function modalMoveCopyGroupbookmarkDatatable(datatableId, datatableVar, urlService){
			    datatableVar = $('#'+datatableId).DataTable( {
				    "serverSide": true,
				    "dom": dtPatternMlxStandard,
				    "language": i18n,
				    "destroy": true,
				    "autoWidth": false,
				    "ajax": {
				        url: urlService,
				        "data": function ( d ) {
	    		        	//this code adds a new parameter in the request
	    		            return $.extend( {}, d, {
	    		              "onlyCollections" : true
	    		            });
	    		          }
				    },
				    "order": [[ 2, 'asc' ], [1, 'asc']],
				    "initComplete": function(settings){
			            $('#'+ datatableId +' tbody td').each(function () {
			            	$(this).attr('title', $(this).text().trim());
			            });
			        },
			        "drawCallback": function(){
	    	            $(".dataTables_paginate.paging_simple_numbers .pagination").addClass("pagination-sm");
	    	            $('.dataTables_paginate.paging_simple_numbers')
	    	            .css( 'display', this.api().data().length <= 0 ?
	    	                 'none' :
	    	                 'block'
	    	            )
	    	        },
				    "columnDefs": [
		                {
		                	"render": function ( data, type, full, meta ) {
								return '<a href="#" onclick="moveTo(\''+full.path+'\')"><i class="'+full.displayIcon+'"></i>'+full.fileName+'</a>';
							},
							"orderable": false,
							"width": "33%",
							"targets": 0
		                },
		                {
		                	"data": "path", 
		                	"width": "34%", 
		                	"targets": 1
		               	},
		               	{
		                	"data": "group.groupname", 
		                	"width": "33%", 
		                	"targets": 2
		               	}
		            ]
				});
				addGoToPage(datatableId, datatableVar);
			}
			
			var moveGroupBookmarksTable;
			var copyGroupBookmarksTable;
			modalMoveCopyGroupbookmarkDatatable('moveGroupBookmarksTable', moveGroupBookmarksTable, '/emc-metalnx-web/groupBookmarks/groupsBookmarksPaginated/');
			modalMoveCopyGroupbookmarkDatatable('copyGroupBookmarksTable', copyGroupBookmarksTable, '/emc-metalnx-web/groupBookmarks/groupsBookmarksPaginated/');
		/*]]>*/
		</script>
	</div>
	<!-- /. content -->

</body>

</html>

